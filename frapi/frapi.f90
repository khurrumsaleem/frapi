module frapi

    use conversions_frapcon
    use conversions_fraptran, only : coneu, jkbtup
    use frapcon4,  only : frapcon_driver
    use fraptran2, only : fraptran_driver
    use m_if_a_else_b, only : if_a_else_b
    use string_functions, only : lower

    implicit none

    integer, parameter :: one = 1, two = 2, three = 3

    real(8), parameter :: intoum = 25.4D+3
    real(8), parameter :: fttom = 0.3048D+0
    real(8), parameter :: fttomm = 0.3048D+3
    real(8), parameter :: fttocm = 0.3048D+2
    real(8), parameter :: mmtoin = 1.D0/25.4D0
    real(8), parameter :: cm2m   = 1.D-2
    real(8), parameter :: cm_to_ft = 1./0.3048D+2

    type, public :: t_fuelrod
        type( frapcon_driver) :: dfcon              ! Burnup steady-state calculations
        type(fraptran_driver) :: dftran             ! Transient calculations
        logical               :: is_initdone        ! The flag is about whether initialization has been finished or not yet
        character(len=200)    :: namerf             ! Name of the restart file generated by frapcon for further fraptran running
        character(len=16)     :: frapmode           ! 'fraptran' or 'frapcon'
    contains
        procedure :: make      => frod_make         ! Initialize the fuel rod
        procedure :: init      => frod_init         ! Set the initial fuel rod state, t = 0
        procedure :: next      => frod_next         ! Perform the trial time step, dt > 0
        procedure :: save      => frod_save         ! Save fuel rod state to local memory
        procedure :: load      => frod_load         ! Load fuel rod state from the local memory
        procedure :: makerf    => frod_makerf       ! Make restart file for futher fraptran running
        procedure :: set_mode  => frod_set_mode     ! choose 'fraptran' or 'frapcon' mode

        ! old interface: ---------------------------------------------------
        procedure :: set_value => frod_set_r8_0    ! Set variable value
        procedure :: set_array => frod_set_r8_1    ! Set variable array
        procedure :: get_value => frod_get_r8_0    ! Get variable value
        procedure :: get_array => frod_get_r8_1    ! Get variable array
        !--------------------------------------------------------------------

        procedure :: set_ch_0  => frod_set_ch_0     ! set variable of type character and rank 0
        procedure :: set_i4_0  => frod_set_i4_0     ! set variable of type integer and rank 0
        procedure :: set_i4_1  => frod_set_i4_1     ! set variable of type integer and rank 1
        procedure :: set_r8_0  => frod_set_r8_0     ! set variable of type real and rank 0
        procedure :: set_r8_1  => frod_set_r8_1     ! set variable of type real and rank 1
        procedure :: set_r8_2  => frod_set_r8_2     ! set variable of type real and rank 2

        procedure :: get_i4_0  => frod_get_i4_0     ! get variable of type integer and rank 0
        procedure :: get_i4_1  => frod_get_i4_1     ! get variable of type integer and rank 1
        procedure :: get_r8_0  => frod_get_r8_0     ! get variable of type real and rank 0
        procedure :: get_r8_1  => frod_get_r8_1     ! get variable of type real and rank 1
        procedure :: get_r8_2  => frod_get_r8_2     ! get variable of type real and rank 2

        procedure :: save_bin  => frod_save_bin     ! Save fuel rod state in a file
        procedure :: load_bin  => frod_load_bin     ! Load fuel rod state from a file
        procedure :: destroy   => frod_destroy      ! Deallocate the fuel rod variables
    end type t_fuelrod

    ! TEMPORARY VARIABLES
    integer :: i, j, n, m
    real(8) :: a, b, c, volume
    real(8), allocatable :: weight(:)
    real(8), allocatable :: tmp0(:), tmp1(:), tmp2(:), tmp3(:), tmp4(:)

contains

    subroutine frod_make(this, nr, na, ngasr, nce, frapmode, &
               mechan, ngasmod, icm, icor, iplant, &
               imox, igascal, zr2vintage, moxtype, idxgas, iq, ivardm,&
               ifixedcoolt, ifixedcoolp, ifixedtsurf, verbose, flag_iapws)

        class (t_fuelrod), intent(inout) :: this

        include "fi_optstatement_h.f90"

        integer :: nr_ = 17
        integer :: na_ = 10
        integer :: ngasr_ = 45
        integer :: nce_ = 5
        logical :: verbose_ = .false. 

        this % frapmode = 'frapcon'

        n  = na
        m  = nr

        if( present(nr          ) ) nr_      = nr
        if( present(na          ) ) na_      = na
        if( present(ngasr       ) ) ngasr_   = ngasr
        if( present(nce         ) ) nce_     = nce
        if( present(verbose     ) ) verbose_ = verbose
        if( present(frapmode    ) ) this % frapmode = frapmode

        ! Check out the mesh size
        if (na_   <= 0) call stop_error("ERROR: got wrong number of axial nodes, na = ", na_)
        if (nr_   <= 0) call stop_error("ERROR: got wrong number of radial nodes in pellet, nr = ", nr_)
        if (nce_  <= 0) call stop_error("ERROR: got wrong number of radial nodes in cladding, nce = ", nce_)
        if (ngasr_<= 0) call stop_error("ERROR: got wrong number of radial nodes in pellet, ngasr = ", ngasr_)

        select case (lower(this % frapmode))

        case ('frapcon')

            call this % dfcon % make(na_, ngasr_, nr_+1, nce_, verbose_)

            call this % dfcon % deft()

            include "fi_optassignment_h.f90"

            call this % dfcon % copy_k2r()

        case ('fraptran')

            ! Allocate FRAPTRAN variables for given mesh sizes
            ! Link pointers of dftran to FRAPTRAN variables
            ! Allocate dftran's replicants of FRAPTRAN variables
            ! Set arguments of 'make' by default
            call this % dftran % make(na_, nr_, nce_, verbose_)

            ! Set dftran's variables (i.e. pointers to FRAPTRAN's variables) by default
            call this % dftran % deft()

            ! Read arguments of 'make' and set them to dftran's variables
            ! include "fi_optassignment_h.f90" TODO: check dftran options

            ! Copy the dftran's variables into replicative variables
            call this % dftran % copy_k2r()

        case default
            write(*,*) "ERROR: option 'mode' must be 'frapcon' or 'fraptran' "

        end select

        ! ALLOCATION OF THE TEMPORARY ARRAYS
        if(.not. allocated(weight)) allocate(weight(m))
        if(.not. allocated(tmp0))   allocate(tmp0(m))
        if(.not. allocated(tmp1))   allocate(tmp1(n))
        if(.not. allocated(tmp2))   allocate(tmp2(m+1))
        if(.not. allocated(tmp3))   allocate(tmp3(n+1))
        if(.not. allocated(tmp4))   allocate(tmp4(n))

        this % is_initdone = .false.

    end subroutine frod_make

    subroutine frod_init(this)

        class (t_fuelrod), intent(inout) :: this

        select case (this % frapmode)
        case ('frapcon')
            call frod_init_frapcon_(this)
        case ('fraptran')
            call frod_init_fraptran_(this)
        end select

        this % is_initdone = .true.

    end subroutine frod_init


    subroutine frod_makerf(this)

        class (t_fuelrod), intent(inout) :: this

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon % copy_r2k()
            call this % dfcon % restfs()
        case default
            call error_message_0 ("ERROR: frapcon mode must be used for writing of restart file")
        end select

    end subroutine frod_makerf


    subroutine frod_init_frapcon_(this)

        class (t_fuelrod), intent(inout) :: this

        call this % dfcon % copy_r2k() ! load variables from driver to kernel
        call this % dfcon % init()     ! processing and checking of input variables
        call this % dfcon % next0()    ! make the very first time step
        call this % dfcon % copy_k2r() ! load variables from kernel to driver

    end subroutine frod_init_frapcon_

    subroutine frod_init_fraptran_(this)

        class (t_fuelrod), intent(inout) :: this

        call this % dftran % copy_r2k() ! load variables from driver to kernel

        this % dftran % ntstep = 1
        this % dftran % nsteadytrans = 1

        call this % dftran % init()   ! init variables, including reading of the restart file
        call this % dftran % next0()  ! make very first time step for steady-state
        call this % dftran % copy_k2r() ! load variables from kernel to driver

    end subroutine frod_init_fraptran_

    subroutine frod_next(this, dt)

        class (t_fuelrod), intent(inout) :: this

        real(8) :: dt

        if (.not. this % is_initdone) then
            call error_message_0 ('ERROR: fuel rod initialization has not been finished!')
        endif
        select case (this % frapmode)
        case ('frapcon')
            call frod_next_frapcon_(this, dt)
        case ('fraptran')
            call frod_next_fraptran_(this, dt)
        end select

    end subroutine frod_next

    subroutine frod_next_frapcon_(this, dt)

        class (t_fuelrod), intent(inout) :: this

        real(8) :: dt

        call this % dfcon % copy_r2k()

        if (dt < 1.E-20) then
            call this % dfcon % next(1.D-12)
        else
            call this % dfcon % next(dt)
        endif

        call this % dfcon % copy_k2r()

    end subroutine frod_next_frapcon_


    subroutine frod_set_mode(this, mode)

        class (t_fuelrod), intent(inout) :: this
        character(*), intent(in) :: mode

        select case (lower(mode))
            case ("frapcon")
                if ((this % dfcon % is_driver_allocated).and.(this % dfcon % is_kernel_allocated)) then
                    this % frapmode = mode
                else
                    call error_message_0 ("ERROR: frapcon solver has not been initialized")
                endif
            case ("fraptran")
                if ((this % dftran % is_driver_allocated).and.(this % dftran % is_kernel_allocated)) then
                    this % frapmode = mode
                else
                    call error_message_0("ERROR: fraptran solver has not been initialized")
                endif
            case default
                write(*,*) "ERROR: given mode is not available, ", mode
        end select

    end subroutine frod_set_mode


    subroutine frod_next_fraptran_(this, dt)

        class (t_fuelrod), intent(inout) :: this

        real(8) :: dt, t0

        t0 = 0.D0
        call this % dftran % copy_r2k()
        call this % dftran % settime(2,t0)
        call this % dftran % settime(4,t0+dt)

        if (dt < 1.E-20) then
            call this % dftran % next(1.D-12)
        else
            call this % dftran % next(dt)
        endif

        call this % dftran % copy_k2r()

    end subroutine frod_next_fraptran_


    subroutine frod_save_bin(this, filename)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: filename

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon  % copy_r2f (filename)
        case ('fraptran')
            call this % dftran % copy_r2f (filename)
        end select

    end subroutine frod_save_bin

    subroutine frod_load_bin(this, filename)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: filename

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon  % copy_f2r (filename)
        case ('fraptran')
            call this % dftran % copy_f2r (filename)
        end select

    end subroutine frod_load_bin

    subroutine frod_load(this)

        class (t_fuelrod), intent(inout) :: this

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon % copy_b2r()
        case ('fraptran')
            call this % dftran % copy_b2r()
        end select

    end subroutine frod_load

    subroutine frod_save(this)

        class (t_fuelrod), intent(inout) :: this

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon % copy_r2b ()
        case ('fraptran')
            this % is_initdone = .true. ! WTF: must be here???
            call this % dftran % copy_r2b()
        end select

    end subroutine frod_save


    subroutine frod_set_ch_0(this, key, var)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: key, var
        integer      :: it

        select case (this % frapmode)
        case ('frapcon')
            select case (lower(key))
            case ("restart file")
                this % dfcon % r__namerf      = trim(var)
            case default
                call error_message(key, 'character rank 0 in the frapcon set-list')
            end select

        case ('fraptran') 
            select case (lower(key))
            case ("restart file")
                this % dftran % r__namerf      = trim(var)
            case ("coolant")
                this % dftran % r__coolant     = trim(var)
            case ("bheat")
                it = if_a_else_b(this % is_initdone, three, one)
                this % dftran % r__bheat       = trim(var)
                this % dftran % r__htca(it,:)  = 2.D+6
            case ("mheat")
                this % dftran % r__mheat       = trim(var)
            case ("reflood")
                this % dftran % r__reflood     = trim(var)
            case ("internal")
                this % dftran % r__internal    = trim(var)
            case ("metal")
                this % dftran % r__metal       = trim(var)
            case ("deformation")
                this % dftran % r__deformation = trim(var)
            case ("inst")
                this % dftran % r__inst        = trim(var)
            case ("relocmodel")
                this % dftran % r__relocmodel  = trim(var)
            case ("radiation")
                this % dftran % r__radiation   = trim(var)
            case default
                call error_message(key, 'character rank 0 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_ch_0

    subroutine frod_set_i4_0(this, key, var)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: key
        integer      :: it
        integer(4)   :: var

        select case (this % frapmode)
        case ('frapcon')
            select case(lower(key))
            case("ifixedcool")
                this % dfcon % r__ifixedcoolt = var
                this % dfcon % r__ifixedcoolp = var
            case default
                call error_message (key, 'integer rank 0 in the frapcon set-list')
            end select
        case ('fraptran')
            select case(lower(key))
            case("azang")
                this % dftran % r__azang = var
            case("istoicgrad")
                this % dftran % r__iStoicGrad = var
            case("prestmp")
                this % dftran % r__prestmp = var
            case("nbhtc")
                this % dftran % r__nbhtc = var
            case("rtheta")
                this % dftran % r__rtheta = var
            case("prescri")
                this % dftran % r__prescri = var
            case("mechan")
                this % dftran % r__mechan = var
            case("nfmesh")
                this % dftran % r__nfmesh = var
            case("numaxprofiles")
                this % dftran % r__NumAxProfiles = var
            case("radiat")
                this % dftran % r__radiat = var
            case("maxit")
                this % dftran % r__maxit = var
            case("tape1")
                this % dftran % r__tape1 = var
            case("jtr")
                this % dftran % r__jtr = var
            case("nrestart")
                this % dftran % r__nrestart = var
            case("irupt")
                this % dftran % r__irupt = var
            case("cladtype")
                this % dftran % r__CladType = var
            case("odoxid")
                this % dftran % r__odoxid = var
            case("nchn")
                this % dftran % r__nchn = var
            case("transwell")
                this % dftran % r__TranSwell = var
            case("noiter")
                this % dftran % r__noiter = var
            case("nthermex")
                this % dftran % r__nthermex = var
            case("indexfc2print")
                this % dftran % r__IndexFC2Print = var
            case("irefine")
                this % dftran % r__irefine = var
            case("protectiveoxide")
                this % dftran % r__ProtectiveOxide = var
            case("nidoxide")
                this % dftran % r__nIDoxide = var
            case("nce")
                this % dftran % r__nce = var
            case("indexgrainbndsep")
                this % dftran % r__IndexGrainBndSep = var
            case("grass")
                this % dftran % r__grass = var
            case("ncolbp")
                this % dftran % r__ncolbp = var
            case("presfgr")
                this % dftran % r__presfgr = var
            case("inp")
                this % dftran % r__inp = var
            case("naz")
                this % dftran % r__naz = var
            case("jchf")
                this % dftran % r__jchf = var
            case("profile")
                this % dftran % r__profile = var
            case("nsym")
                this % dftran % r__nsym = var
            case("geomet")
                this % dftran % r__geomet      = var
            case("nvol1")
                this % dftran % r__nvol1       = var
            case("lowpl")
                this % dftran % r__lowpl       = var
            case("pressu")
                this % dftran % r__pressu      = var
            case("massfl")
                this % dftran % r__massfl      = var
            case("coreav")
                this % dftran % r__coreav      = var
            case("chf")
                this % dftran % r__chf         = var
            case("filmbo")
                this % dftran % r__filmbo      = var
            case("coldwa")
                this % dftran % r__coldwa      = var
            case("axpow")
                this % dftran % r__axpow       = var
            case("bowing")
                this % dftran % r__bowing      = var
            case("spefbz")
                this % dftran % r__spefbz      = var
            case("geometry")
                this % dftran % r__geometry    = var
            case("nbundl")
                this % dftran % r__nbundl      = var
            case("refloodtime")
                this % dftran % r__refloodtime = var
            case("ruptur")
                this % dftran % r__ruptur      = var
            case("liquid")
                this % dftran % r__liquid      = var
            case("inlet")
                this % dftran % r__inlet       = var
            case("reflo")
                this % dftran % r__reflo       = var
            case("pressure")
                this % dftran % r__pressure    = var
            case("collaps")
                this % dftran % r__collaps     = var
            case("frapt4")
                this % dftran % r__frapt4      = var
            case("geom")
                this % dftran % r__geom        = var
            case("temp")
                this % dftran % r__temp        = var
            case("tape2")
                this % dftran % r__tape2       = var
            case("nvol2")
                this % dftran % r__nvol2       = var
            case("zone")
                this % dftran % r__zone        = var
            case("upppl")
                this % dftran % r__upppl       = var
            case("jfb")
                this % dftran % r__jfb         = var
            case("nucbo")
                this % dftran % r__nucbo       = var
            case("unitin")
                this % dftran % r__unitin      = var
            case("unitout")
                this % dftran % r__unitout     = var
            case("res")
                this % dftran % r__res         = var
            case("pow")
                this % dftran % r__pow         = var
            case("gasflo")
                this % dftran % r__gasflo      = var
            case("idoxid")
                this % dftran % r__idoxid      = var
            case("cathca")
                this % dftran % r__cathca      = var
            case("baker")
                this % dftran % r__baker       = var
            case("noball")
                this % dftran % r__noball      = var
            case("cenvoi")
                this % dftran % r__cenvoi      = var
            case("soltyp")
                this % dftran % r__soltyp      = var
            case("totnb")
                this % dftran % r__totnb = var
            case("ncs")
                this % dftran % r__ncs(1) = var
            case("nplnt")
                this % dftran % r__nplnt = var
            case default
                call error_message(key, 'integer rank 0 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_i4_0


    subroutine frod_set_i4_1(this, key, var)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: key
        integer      :: it
        integer(4)   :: var(:)

        select case (this % frapmode)
        case ('frapcon')
            call error_message(key, 'integer rank 1 in the frapcon set-list')
        case ('fraptran')
            select case (lower(key))
            case("ngastmp")
                this % dftran % r__ngastmp(:) = var(:)
            case default
                call error_message(key, 'integer rank 1 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_i4_1


    subroutine frod_set_r8_0(this, key, var)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: key
        integer      :: it, it3, k
        real(8)      :: var

        select case (this % frapmode)
        
        case ('frapcon')
            it  = this % dfcon % r__it
            select case(lower(key))
            case("rodlength")
                this % dfcon % r__deltaz(1:n) = var / n * mtoft
                this % dfcon % r__x(1)        = 0.d0                        ! Axial evaluation for linear power distribution, ft
                this % dfcon % r__x(2:n+1)    = (/( sum(this % dfcon % r__deltaz(:i)), i = 1, n )/)
                this % dfcon % r__deltaz(n+1) = this % dfcon % r__cpl
                this % dfcon % r__totl        = sum(this % dfcon % r__deltaz(1:n))            ! Total length of active fuel, ft
                this % dfcon % r__zcool(:)    = this % dfcon % r__x(:)        ! Axial evaluation for coolant temperature distribution, ft
            case("axial mesh thickness, cm")
                this % dfcon % r__deltaz(1:n) = var * cmtoft
                this % dfcon % r__x(1)        = 0.d0                        ! Axial evaluation for linear power distribution, ft
                this % dfcon % r__x(2:n+1)    = (/( sum(this % dfcon % r__deltaz(:i)), i = 1, n )/)
                this % dfcon % r__deltaz(n+1) = this % dfcon % r__cpl
                this % dfcon % r__totl        = sum(this % dfcon % r__deltaz(1:n))            ! Total length of active fuel, ft
                this % dfcon % r__zcool(:)    = this % dfcon % r__x(:)        ! Axial evaluation for coolant temperature distribution, ft
            case("linear power, w|cm")
                a = var * sum(this % dfcon % r__deltaz(1:n) ) / this % dfcon % r__totl /cmtoft ! W/ft
                b = sum( this % dfcon % r__deltaz(1:n) / this % dfcon % r__dco(1:n) ) &
                    / this % dfcon % r__totl / intoft ! 1/ft
                this % dfcon % r__qmpy(it) = a * b / pi * WtoBTUh ! BTUh/ft^2
                this % dfcon % r__qf(:) = 1.D0 / n
            case("fuel rod pitch, cm")
                this % dfcon % r__pitch = var * cmtoin
            case("as-fabricated apparent fuel density, %td")
                this % dfcon % r__den = var
            case("coolant mass flux, kg|(s*m^2)")
                this % dfcon % r__go(it) = var * ksm2tolbhrft2
            case("additional fuel densification factor")
                this % dfcon % r__afdn         = var
            case("clad texture factor")
                this % dfcon % r__catexf       = var
            case("as-fabricated clad hydrogen content, wt.ppm")
                this % dfcon % r__chorg        = var                       
            case("clad cold work")
                this % dfcon % r__cldwks       = var                       
            case("cold plenum length, m")
                this % dfcon % r__cpl          = var * mtoin
            case("constant crud thickness, mm")
                this % dfcon % r__crdt         = var / miltomm
            case("crud accumulation rate")
                this % dfcon % r__crdtr        = var                       
            case("creep step duration, hr")
                this % dfcon % r__crephr       = var                       
            case("fuel open porosity fraction, %td")
                this % dfcon % r__deng         = var                       
            case("spring diameter, mm")
                this % dfcon % r__dspg         = var * mmtoin              
            case("spring wire diameter, mm")
                this % dfcon % r__dspgw        = var * mmtoin              
            case("number of spring turns")
                this % dfcon % r__vs           = var
            case("peak-to-average power ratio")
                this % dfcon % r__fa           = var                       
            case("fill gas pressure, pa")
                this % dfcon % r__fgpav        = var * PatoPSI             
            case("fuel oxygen-to-metal ratio")
                this % dfcon % r__fotmtl       = var                       
            case("weight ppm h2o in fuel, wt.ppm")
                this % dfcon % r__ppmh2o       = var                       
            case("weight ppm n2 in fuel, wt. ppm")
                this % dfcon % r__ppmn2        = var                       
            case("expected resintering density increase, kg|m^3")
                this % dfcon % r__rsntr        = var                       
            case("fision gas atoms per 100 fissions")
                this % dfcon % r__sgapf        = var                       
            case("swelling limit")
                this % dfcon % r__slim         = var                       
            case("pellet centering temperature, k")
                this % dfcon % r__tsint        = tkf(var)                  
            case("grain size of the fuel, um")
                this % dfcon % r__grnsize      = var                       
            case("fea friction coefficient")
                this % dfcon % r__frcoef       = var                       
            case("percent ifba rods in core, %")
                this % dfcon % r__ifba         = var                       
            case("boron-10 enrichment in zrb2, atom %")
                this % dfcon % r__b10          = var                       
            case("zrb2 thickness, mm")
                this % dfcon % r__zrb2thick    = var * mmtoin               
            case("zrb2 density, %td")
                this % dfcon % r__zrb2den      = var
            case("decay heat multiplier")
                this % dfcon % r__fpdcay       = var                       
            case("molar fraction of air")
                this % dfcon % r__amfair       = var                       
            case("molar fraction of argon")
                this % dfcon % r__amfarg       = var                       
            case("molar fraction of fission gas")
                this % dfcon % r__amffg        = var                       
            case("molar fraction of helium")
                this % dfcon % r__amfhe        = var                       
            case("molar fraction of hydrogen")
                this % dfcon % r__amfh2        = var                       
            case("molar fraction of water")
                this % dfcon % r__amfh2o       = var                       
            case("molar fraction of krypton")
                this % dfcon % r__amfkry       = var                       
            case("molar fraction of nitrogen")
                this % dfcon % r__amfn2        = var                       
            case("molar fraction of xenon")
                this % dfcon % r__amfxe        = var                       
            case("bias on fuel thermal conductivity")
                this % dfcon % r__sigftc       = var                       
            case("bias on fuel thermal expansion")
                this % dfcon % r__sigftex      = var                       
            case("bias on fission gas release")
                this % dfcon % r__sigfgr       = var                       
            case("bias on fuel swelling")
                this % dfcon % r__sigswell     = var                       
            case("bias on cladding creep")
                this % dfcon % r__sigcreep     = var                       
            case("bias on cladding axial growth")
                this % dfcon % r__siggro       = var                       
            case("bias on cladding corrosion")
                this % dfcon % r__sigcor       = var                       
            case("bias on cladding hydrogen pickup")
                this % dfcon % r__sigh2        = var                       
            case("fuel pellet pu-239 content")
                this % dfcon % r__enrpu39      = var                       
            case("fuel pellet pu-240 content")
                this % dfcon % r__enrpu40      = var                       
            case("fuel pellet pu-241 content")
                this % dfcon % r__enrpu41      = var                       
            case("fuel pellet pu-242 content")
                this % dfcon % r__enrpu42      = var
            case("pellet height, mm")
                this % dfcon % r__hplt         = var * mmtoin
            case("chamfer height, mm")
                this % dfcon % r__chmfrh       = var * mmtoin
            case("chamfer width, mm")
                this % dfcon % r__chmfrw       = var * mmtoin
            case("dish shoulder width, mm")
                this % dfcon % r__dishsd       = var * mmtoin
            case("dish height, mm")
                this % dfcon % r__hdish        = var * mmtoin
            case("clad roughness, mm")
                this % dfcon % r__roughc       = var * mmtoin
            case("fuel roughness, mm")
                this % dfcon % r__roughf       = var * mmtoin
            case("end-node to plenum heat transfer fraction")
                this % dfcon % r__qend(it)     = var
            case("rod internal pressure for fea model, mpa")
                this % dfcon % r__p1(it)       = var * patoPSI
            case("inlet coolant temperature, c")
                this % dfcon % r__tw(it) = tcf(var)
            case("inlet coolant pressure, mpa")
                this % dfcon % r__p2(it) = var * MPatoPSI
            case("fuel enrichment by u-235, %")
                this % dfcon % r__enrch(:) = var
            case("cladding thickness, cm")
                this % dfcon % r__thkcld(:) = var * cmtoin
            case("gap thickness, cm")
                this % dfcon % r__thkgap(:) = var * cmtoin
            case("outer cladding diameter, cm")
                this % dfcon % r__dco(:) = var * cmtoin
            case("coolant system pressure, mpa")
                this % dfcon % r__p2(it) = var * MPatoPSI
            case("radius of the fuel pellet central annulus, mm")
                this % dfcon % r__rc(:) = var * mmtoin  
            case("total gap conductance, w|(m^2*k)")
                this % dfcon % r__TotalHgap(:) = var * Wm2KtoBhft2F
                this % dfcon % r__hgapt_flag   = .true.
            case("total gap conductance, w/(m^2*k)")
                this % dfcon % r__TotalHgap(:) = var * Wm2KtoBhft2F
                this % dfcon % r__hgapt_flag   = .true.
            case("gadolinia weight fraction")
                this % dfcon % r__gadoln(:) = var
            case("coolant pressure, mpa")
                this % dfcon % r__p2(it) = var * MPatoPSI
                this % dfcon % r__coolantpressure(it,1:n+1) = var * MPatoPSI
                this % dfcon % r__pcoolant(1:n+1) = var * MPatoPSI
            case("inlet coolant enthalpy, j|kg")
                continue
            case("outlet coolant enthalpy, j|kg")
                continue
            case default
                call error_message (key, 'real(8) rank 0 in the frapcon set-list')
            end select

        case ('fraptran')
            it3 = if_a_else_b(this % is_initdone, 3, 1)
            select case (lower(key))
            case("splbp")
                this % dftran % r__splbp = var
            case("tpowf")
                this % dftran % r__tpowf = var
            case("ruptstrain")
                this % dftran % r__ruptstrain = var
            case("frcoef")
                this % dftran % r__frcoef = var
            case("epsht1")
                this % dftran % r__epsht1 = var
            case("cladpower")
                this % dftran % r__CladPower = var
            case("pitch")
                this % dftran % r__pitch = var
            case("fuel rod pitch, cm")
                this % dftran % r__pitch = var * cmtom
            case("bowthr")
                this % dftran % r__bowthr = var
            case("dofang")
                this % dftran % r__dofang = var
            case("coldbp")
                this % dftran % r__coldbp = var
            case("frden")
                this % dftran % r__frden = var
            case("roddiameter")
                this % dftran % r__RodDiameter = var
            case("refdtm")
                this % dftran % r__refdtm = var
            case("powop")
                this % dftran % r__powop = var
            case("flxsec")
                this % dftran % r__flxsec = var
            case("ffch")
                this % dftran % r__ffch = var
            case("fpdcay")
                this % dftran % r__fpdcay = var
            case("roughc")
                this % dftran % r__roughc = var
            case("roughf")
                this % dftran % r__roughf = var
            case("prsacc")
                this % dftran % r__prsacc = var
            case("fpowr")
                this % dftran % r__fpowr = var
            case("tref")
                this % dftran % r__tref = var
            case("pelh")
                this % dftran % r__pelh = var
            case("pdrato")
                this % dftran % r__pdrato = var
            case("tgas0")
                this % dftran % r__tgas0 = var
            case("tsntrk")
                this % dftran % r__tsntrk = var
            case("spdbp")
                this % dftran % r__spdbp = var
            case("achn")
                this % dftran % r__achn = var
            case("tflux")
                this % dftran % r__tflux = var
            case("rodlength")
                this % dftran % r__RodLength = var
            case("opf")
                this % dftran % r__OpenPorosityFraction = var
            case("zad")
                this % dftran % r__zad = var
            case("rshrd")
                this % dftran % r__rshrd = var
            case("doffst")
                this % dftran % r__doffst = var
            case("emptm")
                this % dftran % r__emptm = var
            case("trise")
                this % dftran % r__trise = var
            case("fltgap2")
                this % dftran % r__fltgap2 = var
            case("hydiam")
                this % dftran % r__hydiam = var
            case("dishd")
                this % dftran % r__dishd = var
            case("ph")
                this % dftran % r__ph = var
            case("hrad")
                this % dftran % r__hrad = var
            case("dtss")
                this % dftran % r__dtss = var
            case("bup")
                this % dftran % r__bup = var
            case("cldwdc")
                this % dftran % r__cldwdc = var
            case("timop")
                this % dftran % r__timop = var
            case("cfluxa")
                this % dftran % r__cfluxa = var
            case("rvoid")
                this % dftran % r__rvoid = var
            case("dofset")
                this % dftran % r__dofset = var
            case("pl")
                this % dftran % r__pl = var
            case("fltgap")
                this % dftran % r__fltgap = var
            case("frpo2")
                this % dftran % r__frpo2 = var
            case("trest")
                this % dftran % r__trest = var
            case("fgrns")
                this % dftran % r__fgrns = var
            case("refine")
                this % dftran % r__refine = var
            case("modheat")
                this % dftran % r__modheat = var
            case("tmpac1")
                this % dftran % r__tmpac1 = var
            case("coldw")
                this % dftran % r__coldw = var
            case("dhe")
                this % dftran % r__dhe = var
            case("explenumv")
                this % dftran % r__explenumv = var
            case("dhy")
                this % dftran % r__dhy = var
            case("volbp")
                this % dftran % r__volbp = var
            case("rshd")
                this % dftran % r__rshd = var
            case("fotmtl")
                this % dftran % r__fotmtl = var
            case("gsms")
                this % dftran % r__gsms = var
            case("dishv0")
                this % dftran % r__dishv0 = var
            case("rnbnt")
                this % dftran % r__rnbnt = var
            case("zvoid2")
                this % dftran % r__zvoid2 = var
            case("gapthk")
                this % dftran % r__gapthk = var
            case("zvoid1")
                this % dftran % r__zvoid1 = var
            case("zs")
                this % dftran % r__zs = var
            case("fuelpeldiam")
                this % dftran % r__FuelPelDiam = var
            case("hbh")
                this % dftran % r__hbh(it3) = var
            case("hupta")
                this % dftran % r__hupta(it3) = var
            case("outlet coolant enthalpy, j|kg")
                this % dftran % r__hupta(it3) = var
            case("hinta")
                this % dftran % r__hinta(it3) = var
            case("inlet coolant enthalpy, j|kg")
                this % dftran % r__hinta(it3) = var * jkbtup
            case("gbh")
                this % dftran % r__gbh(it3) = var
            case("coolant mass flux, kg|(s*m^2)")
                this % dftran % r__gbh(it3) = var * ksm2tolbhrft2
            case("explenumt")
                this % dftran % r__explenumt(it3) = var
            case("pbh")
                this % dftran % r__pbh(it3) = var
            case("inlet coolant pressure, mpa")
                this % dftran % r__pbh(it3) = var * MPatoPSI
            case("inlet coolant temperature, c")
                this % dftran % intcool = var + 273.15
            case("rodavepower")
                call assignvar(this % is_initdone, var, this % dftran % r__RodAvePower)
            case("fuelgasswell")
                this % dftran % r__FuelGasSwell(it3) = var
            case("temptm")
                this % dftran % r__temptm(it3) = var
            case("relfraca")
                this % dftran % r__relfraca(it3) = var
            case("prestm")
                this % dftran % r__prestm(it3) = var
            case("fldrat")
                this % dftran % r__fldrat(it3) = var
            case("gasphs")
                this % dftran % r__gasphs(it3) = var
            case("hlqcl")
                this % dftran % r__hlqcl(it3) = var
            case("spl")
                this % dftran % r__spl(1) = var
            case("scd")
                this % dftran % r__scd(1) = var
            case("swd")
                this % dftran % r__swd(1) = var
            case("gappr0")
                this % dftran % r__gappr0(1) = var
            case("gfrac-he")
                this % dftran % r__gfrac(1) = var
                this % dftran % r__gasfraction(1) = var
            case("gfrac-ar")
                this % dftran % r__gfrac(2) = var
                this % dftran % r__gasfraction(2) = var
            case("gfrac-kr")
                this % dftran % r__gfrac(3) = var
                this % dftran % r__gasfraction(3) = var
            case("gfrac-xe")
                this % dftran % r__gfrac(4) = var
                this % dftran % r__gasfraction(4) = var
            case("gfrac-h")
                this % dftran % r__gfrac(5) = var
                this % dftran % r__gasfraction(5) = var
            case("gfrac-n")
                this % dftran % r__gfrac(8) = var
                this % dftran % r__gasfraction(6) = var
            case("gfrac-air")
                this % dftran % r__gfrac(6) = var
                this % dftran % r__gasfraction(7) = var
            case("gfrac-h2o")
                this % dftran % r__gfrac(7) = var
                this % dftran % r__gasfraction(8) = var
            case("gadolinia weight fraction")
                this % dftran % r__gadoln(1:n) = var
            case("fuel enrichment by u-235, %")
                continue
    !        case("ProfileStartTime")
    !            this % dftran % r__ProfileStartTime(it_) = var
            case("vplen")
                this % dftran % r__vplen(1) = var
            case("axial mesh thickness, cm")
                tmp4(:) = var
                call this % set_r8_1 (key, tmp4)
            case("linear power, w|cm")
                tmp4(:) = var
                call this % set_r8_1 (key, tmp4)
            case default
                call error_message(key, 'real(8) rank 0 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_r8_0

    subroutine frod_set_r8_1(this, key, var)

        class (t_fuelrod), intent(inout) :: this
        real(8), intent(in)      :: var(:)

        character(*) :: key
        integer      :: it, k, it3
        real(8)      :: a

        select case (this % frapmode)

        case ('frapcon')
            it  = this % dfcon % r__it
            select case(lower(key))
            case("axial mesh thickness, cm")
                this % dfcon % r__deltaz(1:n) = var(:) * cmtoft
                this % dfcon % r__x(1)        = 0.d0                        ! Axial evaluation for linear power distribution, ft
                this % dfcon % r__x(2:n+1)    = (/( sum(this % dfcon % r__deltaz(:i)), i = 1, n )/)
                this % dfcon % r__deltaz(n+1) = this % dfcon % r__cpl
                this % dfcon % r__totl        = sum(this % dfcon % r__deltaz(1:n))            ! Total length of active fuel, ft
                this % dfcon % r__zcool(:)    = this % dfcon % r__x(:)        ! Axial evaluation for coolant temperature distribution, ft
            case("cladding thickness, cm")
                this % dfcon % r__thkcld(1:n) = var(:) * cmtoin
            case("gap thickness, cm")
                this % dfcon % r__thkgap(1:n) = var(:) * cmtoin
            case("outer cladding diameter, cm")
                this % dfcon % r__dco(1:n) = var(:) * cmtoin

            ! Must be removed in the future ---------------------------------------------------------
            case("frapcon format: linear power, w|cm")
                this % dfcon % r__qmpy(it) = sum(var) / cmtoft * & 
                sum(this % dfcon % r__deltaz(1:n) / this % dfcon % r__dco(1:n)) &
                / pi / intoft * WtoBTUh / this % dfcon % r__totl
                this % dfcon % r__qf(:) = var(:) / sum(var)
            case("frapcon format: coolant temperature, c")
                this % dfcon % r__coolanttemp(it,1:n+1) = (/( tcf(var(i)), i = 1, n+1 )/)
                this % dfcon % r__tcoolant(1:n+1) = (/( tcf(var(i)), i = 1, n+1 )/)
            case("frapcon format: coolant pressure, mpa")
                this % dfcon % r__p2(it) = var(1) * MPatoPSI
                this % dfcon % r__coolantpressure(it,1:n+1) = var(:) * MPatoPSI
                this % dfcon % r__pcoolant(1:n+1) = var(:) * MPatoPSI
            case("frapcon format: gadolinia weight fraction")
                this % dfcon % r__gadoln(:) = var(:)
            case("frapcon format: fuel enrichment by u-235, %")
                this % dfcon % r__enrch(:) = var(:)

            ! ----------------------------------------------------------------------------------------

            case("linear power, w|cm")
                call linterp(var, this % dfcon % r__deltaz(1:n), tmp3, n)
                a = sum( var(:) * this % dfcon % r__deltaz(1:n) ) / this % dfcon % r__totl /cmtoft ! W/ft
                b = sum( this % dfcon % r__deltaz(1:n) / this % dfcon % r__dco(1:n) ) &
                    / this % dfcon % r__totl / intoft ! 1/ft
                this % dfcon % r__qmpy(it) = a * b / pi * WtoBTUh ! BTUh/ft^2
                this % dfcon % r__qf(:) = (tmp3(:) + 1.D-10) / (sum(tmp3) + 1.D-10)
            case("coolant temperature, c")
                call linterp(var,  this % dfcon % r__deltaz(1:n), tmp3, n)
                this % dfcon % r__coolanttemp(it,1:n+1) = (/( tcf(tmp3(i)), i = 1, n+1 )/)
                this % dfcon % r__tcoolant(1:n+1) = (/( tcf(tmp3(i)), i = 1, n+1 )/)
            case("coolant pressure, mpa")
                call linterp(var, this % dfcon % r__deltaz(1:n), tmp3, n)
                this % dfcon % r__p2(it) = var(1) * MPatoPSI
                this % dfcon % r__coolantpressure(it,1:n+1) = tmp3(:) * MPatoPSI
                this % dfcon % r__pcoolant(1:n+1) = tmp3(:) * MPatoPSI
            case("input fuel burnup")
                this % dfcon % r__buin(:)      = var(:) * MWskgUtoMWdMTU
            case("puo2 weight percent if mox fuel, wt%")
                this % dfcon % r__comp(:)      = var(:)
            case("heat flux, w|m^2")
                this % dfcon % r__qc(:)        = var(:) / Bhft2toWm2
            case("gadolinia weight fraction")
                call linterp(var,  this % dfcon % r__deltaz(1:n), tmp3, n)
                this % dfcon % r__gadoln(:)    = tmp3(:)
            case("cladding surface temperature, k")
                this % dfcon % r__cladt(:)     = (/( tkf(var(i)), i = 1, n )/)
            case("axial crud thickness multiplier")
                this % dfcon % r__crudmult(:)  = var(:)
            case("neutron flux, 1|(cm^2*s)")
                this % dfcon % r__flux(:)  = var(:)
            case("fuel enrichment by u-235, %")
                call linterp(var,  this % dfcon % r__deltaz(1:n), tmp3, n)
                this % dfcon % r__enrch(:) = tmp3(:)
            case default
                call error_message(key, 'real rank 1 in the frapcon set-list')
            end select

        case ('fraptran')
            select case (lower(key))
            case("azpang")
                this % dftran % r__azpang(1:n) = var(:)
            case("fmesh")
                this % dftran % r__fmesh(1:n) = var(:)
            case("htclev")
                this % dftran % r__htclev(1:n) = var(:)
            case("extentofbow")
                this % dftran % r__ExtentOfBow(1:n) = var(:)
            case("gadoln")
                this % dftran % r__gadoln(1:n) = var(:)
            case("gadolinia weight fraction")
                this % dftran % r__gadoln(1:n) = var(:)
            case("gbse")
                this % dftran % r__gbse(1:n) = var(:)
            !case("gfrac")
            !    this % dftran % r__gfrac(:) = var(:)
            case("fluxz")
                this % dftran % r__fluxz(1:n) = var(:)
            case("nodchf")
                this % dftran % r__nodchf(1:n) = var(:)
            case("oxideod")
                this % dftran % r__oxideod(1:n) = var(:)
            case("cexh2a")
                this % dftran % r__cexh2a(1:n) = var(:)
            case("radpel")
                this % dftran % r__radpel(1:n) = var(:)
            case("cmesh")
                this % dftran % r__cmesh(1:n) = var(:)
            case("butemp")
                this % dftran % r__butemp(1:n) = var(:)
            case("oxideid")
                this % dftran % r__oxideid(1:n) = var(:)
            case("eppinp")
                this % dftran % r__eppinp(1:n) = var(:)
            case("techf")
                this % dftran % r__techf(1:n) = var(:)
            case("tschf")
                this % dftran % r__tschf(1:n) = var(:)
            case("zelev")
                this % dftran % r__zelev(1:n) = var(:)
            case("fuel enrichment by u-235, %")
                continue
            case("htca")
                it = if_a_else_b(this % is_initdone, three, one)
                k = this % dftran % r__zone
                this % dftran % r__htca(it,1:k) = var(:)
            case("tblka")
                it = if_a_else_b(this % is_initdone, three, one)
                k = this % dftran % r__zone
                this % dftran % r__tblka(it,1:k) = var(:)
            case("gasths")
                it = if_a_else_b(this % is_initdone, three, one)
                k = this % dftran % r__zone
                this % dftran % r__gasths(it,1:k) = var(:)
            case("radtemp")
                it = if_a_else_b(this % is_initdone, two, one)
                this % dftran % r__radtemp(:,it) = var(:)
            case("fuelrad")
                it = if_a_else_b(this % is_initdone, two, one)
                this % dftran % r__fuelrad(:,it) = var(:)
            case("axpowprofile")
                it = if_a_else_b(this % is_initdone, two, one)
                this % dftran % r__axpowprofile(1:2*(n+1),it) = var(:)
            case("radpowprofile")
                this % dftran % r__radpowprofile(1:2*n*m) = var(:)
            case("linear power, w|cm")
                ! 'fraptran' re-interpolates the linear power for the main axial mesh with n central nodes
                ! User can set 'axpowprofile' for arbitrary axial mesh, however not 
                ! at the central nodes, but at the last nodes (here n+1 nodes of the main mesh)
                call linterp(var, this % dftran % axialmesh(:), tmp3, n)
                tmp3(:) = (tmp3(:) + 1.D-12) / (sum(tmp3) + 1.D-12)
                it = if_a_else_b(this % is_initdone, two, one)
                do i = 1, n + 1
                    this % dftran % r__axpowprofile(2*i-1,it) = tmp3(i)
                    this % dftran % r__axpowprofile(2*i  ,it) = this % dftran % axnodelevat(i)
                enddo
                ! linear power, W/cm -> average linear power, W/cm
                a = sum( (/( var(i) * this % dftran % axialmesh(i), i = 1, n )/) ) / sum(this % dftran % axialmesh)
                it3 = if_a_else_b(this % is_initdone, three, one)
                ! average linear power, W/cm -> average linear power, kW/ft
                this % dftran % r__RodAvePower(it3) = a * 1.D-3 / cm_to_ft
            case("axial mesh thickness, cm")
                this % dftran % axialmesh(:) = var(:)
                this % dftran % axnodelevat(1) = 0.D+0
                this % dftran % axnodelevat(2:n+1) = (/( sum(var(1:i)), i = 1, n )/) * cm_to_ft
                this % dftran % r__RodLength = sum(var) * cm_to_ft
            case default
                call error_message(key, 'real rank 1 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_r8_1


    subroutine frod_set_r8_2(this, key, var)

        class (t_fuelrod), intent(inout) :: this

        character(*) :: key
        integer      :: it
        real(8)      :: var(:,:)

        select case (this % frapmode)
        case ('frapcon')
            call error_message(key, 'real rank 2 in the frapcon set-list')
        case ('fraptran')
            select case (lower(key))
            case("pazp")
                this % dftran % r__pazp(:,:) = var(:,:)
            case("relative power profile")
! TODO: complete it
!                this % dftran % radtemp(k,j)
!                this % dftran % fuelrad(k,j)
!                icnt = 1
!                DO k = 1, naxn
!                    DO j = 1, nradq
!                        ! Relative radial power profile value
!                        radtemp(k,j) = RadPowProfile(icnt)
!                        ! Radius for relative radial power profile value
!                        fuelrad(k,j) = RadPowProfile(icnt+1)
!                        ! Increment counter by 2
!                        icnt = icnt + 2
!                    ENDDO
!                ENDDO

            case default
                call error_message(key, 'real rank 2 in the fraptran set-list')
            end select
        end select

    end subroutine frod_set_r8_2

    subroutine frod_get_i4_0(this, key, var)

        class (t_fuelrod), intent(in) :: this

        character(*) :: key
        integer      :: var

        select case (this % frapmode)
        case ('frapcon')
            select case (lower(key))
            case('program terminate')
                var = this % dfcon % r__iquit
            case default
                call error_message(key, 'integer rank 0 in the frapcon get-list')
            end select
        case ('fraptran')
            select case (lower(key))
            case('dimension of radial node vectors')
                var = this % dftran % r__n1
            case('dimension of axial node vectors')
                var = this % dftran % r__n2
            case('number of nodes in mesh')
                var = this % dftran % r__nmesh
            case('number of nodes to gas gap / clad boundary')
                var = this % dftran % r__ncladi
            case('node number at surface of fuel pellet stack')
                var = this % dftran % r__igpnod
            case('deformation model indicator')
                var = this % dftran % r__modfd
            case('number of axial nodes')
                var = this % dftran % r__naxn
            case('iteration count')
                var = this % dftran % r__iterationcount
            case('total number of half meshes')
                var = this % dftran % r__n3
            case('balon2 predicts failure')
                var = this % dftran % r__ifbaln
            case('balon2 radial contact node')
                var = this % dftran % r__jmnbal
            case('balon2 predicts pellet-clad contact')
                var = this % dftran % r__kntbal
            case('balon2 has been called once')
                var = this % dftran % r__nbncal
            case('number flow area reduction subnodes')
                var = this % dftran % r__nodprm
            case('mode of cladding failure')
                var = this % dftran % r__modfal(1)
            case("failure indicator")
                if (sum(this % dftran % r__iffrp (1:n)) == 0) then
                    var = 0
                else
                    var = 1
                endif
            case default
                call error_message(key, 'integer rank 0 in the fraptran get-list')
            end select
        end select

    end subroutine frod_get_i4_0

    subroutine frod_get_i4_1(this, key, var)

        class (t_fuelrod), intent(in) :: this

        character(*) :: key
        integer      :: var(:)

        select case (this % frapmode)
        case ('frapcon')
            select case (lower(key))
            case default
                call error_message(key, 'integer rank 1 in the frapcon get-list')
            end select
        case ('fraptran')
            select case(lower(key))
            case('heat transfer mode')
                var(:) = this % dftran % r__ih (1:n)
            case('rupture indicator')
                var(:) = this % dftran % r__ruptfailindex (1:n)
            case('buckled cladding indicator')
                var(:) = this % dftran % r__cladcollapseindex (1:n)
            case("index failure indicator")
                var(:) = this % dftran % r__iffrp (1:n)
            case default
                call error_message(key, 'integer rank 1 in the fraptran get-list')
            end select
        end select

    end subroutine frod_get_i4_1


    subroutine frod_get_r8_0(this, key, var)

        class (t_fuelrod), intent(in) :: this

        character(*) :: key
        integer      :: it
        real(8)      :: var

        select case (this % frapmode)
        case ('frapcon')

            it = this % dfcon % r__it

            select case(lower(key))
            case('average linear power, w|cm')
                var = this % dfcon % r__qmpy(it) * BTUhtokW * &
                     (this % dfcon % r__dcoBOL * intoft * pi) / this % dfcon % r__fa * &
                      1.D+3 * cmtoft
            case('outlet coolant mass flux, kg|(s*m^2)')
                var = this % dfcon % r__go(it) * lbhrft2toksm2
            case('plenum gas temperature, c')
                var = tfc(this % dfcon % r__tplen)
            case('plenum gas pressure, mpa')
                var = this % dfcon % r__press * PSItoMPa
            case('fission gas release, %')
                if(this % dfcon % r__ngasmod == 4) then
                    var = sum(this % dfcon % r__rb_rod(:,it)) * 100.d0
                else
                    var = this % dfcon % r__tfgfr * 100.d0
                endif
            case('time, day')
                var = this % dfcon % r__ProblemTime(it) * sectoday
            case('average fuel burnup, mw*d|kg')
                var = this % dfcon % r__bu * 1.D-3
            case default
                call error_message(key, 'real rank 0 in the frapcon get-list')
            end select
        case ('fraptran')
            select case (lower(key))
            case('fuel stack elongation, mm')
                var = this % dftran % r__delth * fttomm
            case('cladding axial elongation, mm')
                var = this % dftran % r__dcldh * fttomm
            case('fuel average burnup, mwd|mtu')
                var = this % dftran % r__bup
            case('plutonium weight fraction')
                var = this % dftran % r__frpo2
            case('total void volume, mm^3')
                var = this % dftran % r__totalvoidvol * fttomm ** 3
            case('maximum hoop stress in balloon region, mpa')
                var = this % dftran % r__chstrs * PSItoMPa
            case('balon2 circular/radial model switch')
                var = this % dftran % r__frbal
            case('balon2 maximum gap pressure, mpa')
                var = this % dftran % r__pmxbal * PSItoMPa
            case('balon2 average radius at balon2 axial node 8, m')
                var = this % dftran % r__r8bal
            case('maximum circumferential strain in balloon region, %')
                var = this % dftran % r__tcebal
            case('bundle pitch to rod diameter ratio')
                var = this % dftran % r__pdrato
            case('ratio of balloonable cells to total cells')
                var = this % dftran % r__rnbnt
            case('total number of cells in a bundle')
                var = this % dftran % r__totnb
            case('average fuel rod power, kw|m')
                var = this % dftran % r__powave (1) / fttom
            case('flow blockage, %')
                var = this % dftran % r__flwblk (1)
            case('plenum gas temperature, k')
                var = tfk(this % dftran % r__tp (1))
            case('gas flow rate, g*moles/sec')
                var = this % dftran % r__flowg (1)
            case('fuel melt temperature, k')
                var = tfk(this % dftran % r__tmelt (1))
            case('plenum gas pressure, mpa')
                var = this % dftran % r__gaspress(n+1) * PSItoMPa
            case('total water metal reaction energy, kw|m')
                var = sum(this % dftran % r__watrmetlenrgy(1:n)) / fttom
            case default
                call error_message(key, 'real rank 0 in the fraptran get-list')
            end select
        end select

    end subroutine frod_get_r8_0

    subroutine frod_get_r8_1(this, key, var)

        class (t_fuelrod), intent(in) :: this

        character(*) :: key
        integer      :: it
        real(8)      :: var(:) ! array (n,)
!        real(8)      :: ra, rb, ya, yb, h, temper, volume
!        real(8)      :: linteg ! integral of linear function

        select case (this % frapmode)
        case ('frapcon')
            it = this % dfcon % r__it

            select case(lower(key))
    !        case('axial fuel temperature, C')
    !            do i = 1, n
    !                volume = 0
    !                temper = 0
    !                do j = 1, m
    !                    ya = 1.d0
    !                    yb = 1.d0
    !                    ra = this % dfcon % r__hrad(j+1,i)
    !                    rb = this % dfcon % r__hrad(j,i)
    !                    h = this % dfcon % r__x(i+1) - this % dfcon % r__x(i)
    !                    volume = volume + linteg(ya,yb,ra,rb,h)
    !                    ya = this % dfcon % r__tmpfuel(j+1,i)
    !                    yb = this % dfcon % r__tmpfuel(j,i)
    !                    temper = temper + linteg(ya,yb,ra,rb,h)
    !                enddo
    !                var(i) = tfc(temper / volume)
    !            enddo
            case('fuel volume average temperature, c')
                var(:) = (/( tfc(this % dfcon % r__PelAveTemp(i)), i = 1, n )/)
            case('pellet average temperature, c')
                var(:) = (/( tfc(this % dfcon % r__PelAveTemp(i)), i = 1, n )/)
            case('gap average temperature, c')
                var(:) = (/( tfc(this % dfcon % r__GapAveTemp(i)), i = 1, n )/)
            case('cladding average temperature, c')
                var(:) = (/( tfc(this % dfcon % r__CladAveTemp(i)), i = 1, n )/)
            case('bulk coolant temperature, c')
                var(:) = 0.5d0 * ( this % dfcon % r__BulkCoolantTemp(1:n) + this % dfcon % r__BulkCoolantTemp(2:n+1) )
                var(:) = (/( tfc(var(i)), i = 1, n )/)
            case('total gap conductance, w|(m^2*k)')
                var(:) = this % dfcon % r__TotalHgap(1:n) * Bhft2FtoWm2K
            case('total gap conductance, w/(m^2*k)')
                var(:) = this % dfcon % r__TotalHgap(1:n) * Bhft2FtoWm2K
            case('oxide thickness, um')
                var(:) = this % dfcon % r__EOSZrO2Thk(1:n) * fttomil * miltoum
            case('thermal gap thickness, um')
                var(:) = this % dfcon % r__gapplot(1:n) * miltoum
            case('mechanical gap thickness, um')
                var(:) = this % dfcon % r__FuelCladGap(1:n) * 1.D+3 * miltoum
            case('gap pressure, mpa')
                var(:) = this % dfcon % r__GapPress(1:n) * PSItoMPa
            case('cladding total hoop strain, %')
                var(:) = this % dfcon  % eps(1:n,1) * 100
            case('cladding total axial strain, %')
                var(:) = this % dfcon  % eps(1:n,2) * 100
            case('cladding total radial strain, %')
                var(:) = this % dfcon  % eps(1:n,3) * 100
            case('cladding permanent hoop strain, %')
                var(:) = this % dfcon  % epp(1:n,1) * 100
            case('cladding permanent axial strain, %')
                var(:) = this % dfcon  % epp(1:n,2) * 100
            case('cladding permanent radial strain, %')
                var(:) = this % dfcon  % epp(1:n,3) * 100
            case('cladding termal hoop strain, %')
                var(:) = this % dfcon % r__ThermalStrain(1:n,1) * 100
            case('cladding termal axial strain, %')
                var(:) = this % dfcon % r__ThermalStrain(1:n,2) * 100
            case('cladding termal radial strain, %')
                var(:) = this % dfcon % r__ThermalStrain(1:n,3) * 100
            case('cladding hoop stress, mpa')
                var(:) = this % dfcon  % sig(1:n,1) * PSItoMPa
            case('cladding axial stress, mpa')
                var(:) = this % dfcon  % sig(1:n,2) * PSItoMPa
            case('cladding radial stress, mpa')
                var(:) = this % dfcon  % sig(1:n,3) * PSItoMPa
            case('cladding inner radius displacement, mm')
                var(:) = this % dfcon % r__totinner(1:n) * intomm
            case('cladding outer radius displacement, mm')
                var(:) = this % dfcon % r__totcrl(1:n) * intomm
            case('cladding creep rate')
                var(:) = this % dfcon % r__creapratearray(1:n)
            case('fuel surface outward displacement, mm')
                var(:) = this % dfcon % r__totdef(1:n) * intomm
            case('fuel thermal expansion, mm')
                var(:) = this % dfcon % r__fuelexptot(1:n) * intomm
            case('fuel swelling, um')
                var(:) = this % dfcon % r__fuelswltot(1:n) * intoum
            case('fuel creep, mm')
                var(:) = this % dfcon % r__fuelcreeptot(1:n) * intomm
            case('fuel densification, mm')
                var(:) = this % dfcon % r__fueldentot(1:n) * intomm
            case('fuel relocation, mm')
                var(:) = this % dfcon % r__relocation(1:n) * intomm
            case('cladding hydrogen concentration, ppm')
                var(:) = this % dfcon % r__CladH2Concen(1:n)
            case('coolant density, kg|m^3')
                var(:) = 0.5d0*(this % dfcon % r__rhof(1:n) + this % dfcon % r__rhof(2:n+1)) * lbft3tokgm3 
            case('coolant pressure, mpa')
                var(:) = this % dfcon % r__coolantpressure(it,1:n) * PSItoMPa
            case('axial mesh thickness, cm')
                var(:) = this % dfcon % r__deltaz(1:n) / cmtoft
            case('axial mesh elevation, cm')
                var(:) = 0.5d0 * (this % dfcon % r__x(1:n) + this % dfcon % r__x(2:n+1)) / cmtoft
            case('gas release fractions')
                var(:) = this % dfcon % r__RB_rod(1:11,it)
            case('centerline temperature, c')
                var(:) = (/( tfc(this % dfcon % r__tmpfuel(m+1,i)), i = 1, n )/)
            case('fuel stored energy, j|kg')
                var(:) = this % dfcon % r__StoredEnergy(1:n) * BTUlbtoJkg
            case('fuel burnup, mw*d|kg')
                var(:) = this % dfcon % r__EOSNodeburnup(1:n) * 1.D-3 ! / MWskgUtoMWdMTU
            case('cladding inner temperature, c')
                var(:) = (/(tfc(this % dfcon % r__CladInSurfTemp(i)), i = 1, n )/) 
            case('cladding outer temperature, c')
                var(:) = (/(tfc(this % dfcon % r__CladOutSurfTemp(i)), i = 1, n )/)  
            case('cladding middle temperature, c')
                var(:) = (/(tfc(this % dfcon % r__CladOutSurfTemp(i) + this % dfcon % r__CladOutSurfTemp(i))*0.5d0, i = 1, n )/)  
            case('radial meshes, cm')
                var(:) = (/(this % dfcon % r__hrad(m - i + 1, 1), i = 0, m )/) 
                var(:) = var(:) * intocm
            case('pellet centerline temperature, c')
                var(:) = (/( tfc(this % dfcon % r__tmpfuel(m+1,i)), i = 1, n )/)
            case('pellet surface temperature, c')
                var(:) = (/( tfc(this % dfcon % r__tmpfuel(1,i)), i = 1, n )/)
            case('pellet doppler temperature, c')
                tmp1(:) = (/( tfc(this % dfcon % r__tmpfuel(m+1,i)), i = 1, n )/)
                tmp4(:) = (/( tfc(this % dfcon % r__tmpfuel(1,i)), i = 1, n )/)
                var(:) = 0.93 * tmp1(:) + 0.07 * tmp4(:)
            case default
                call error_message(key, 'real rank 1 in the frapcon get-list')
            end select
        case('fraptran')
            select case (lower(key))
            case("axial mesh thickness, cm")
                var(:) = this % dftran % axialmesh(1:n)
            case('cladding total hoop strain, %')
                var(:) = this % dftran % r__CldStrn(1:n,1)
            case('cladding total axial strain, %')
                var(:) = this % dftran % r__CldStrn(1:n,2)
            case('cladding total radial strain, %')
                var(:) = this % dftran % r__CldStrn(1:n,3)
            case('cladding plastic hoop strain, %')
                var(:) = this % dftran % r__CldPlasStrn(1:n,1)
            case('cladding plastic axial strain, %')
                var(:) = this % dftran % r__CldPlasStrn(1:n,2)
            case('cladding plastic radial strain, %')
                var(:) = this % dftran % r__CldPlasStrn(1:n,3)
            case('cladding elastic hoop strain, %')
                var(:) = this % dftran % r__CldElStrn(1:n,1)
            case('cladding elastic axial strain, %')
                var(:) = this % dftran % r__CldElStrn(1:n,2)
            case('cladding elastic radial strain, %')
                var(:) = this % dftran % r__CldElStrn(1:n,3)
            case('cladding thermal hoop strain, %')
                var(:) = this % dftran % r__CldThermStrn(1:n,1)
            case('cladding thermal axial strain, %')
                var(:) = this % dftran % r__CldThermStrn(1:n,2)
            case('cladding thermal radial strain, %')
                var(:) = this % dftran % r__CldThermStrn(1:n,3)
            case('cladding hoop stress, mpa')
                var(:) = this % dftran % r__CldStress(1:n,1) * PSItoMPa
            case('cladding axial stress, mpa')
                var(:) = this % dftran % r__CldStress(1:n,2) * PSItoMPa
            case('cladding radial stress, mpa')
                var(:) = this % dftran % r__CldStress(1:n,3) * PSItoMPa
            case('average cladding temperature, k')
                var(:) = (/( tfk(this % dftran % r__CladAveTemp(i)), i = 1, n)/)
            case('cold state radius, mm')
                var(:) = this % dftran % r__radialbound (1:n)
            case('cldpermaxstrn')
                var(:) = this % dftran % r__cldpermaxstrn (1:n)
            case('cldpermhoopstrn')
                var(:) = this % dftran % r__cldpermhoopstrn (1:n)
            case('gap pressure, mpa')
                var(:) = this % dftran % r__gaspress (1:n) * PSItoMPa
            case('axial power, kw|m')
                var(:) = this % dftran % r__axialpowr (1:n) / fttom
            case('surface heat flux, w|m^2')
                var(:) = this % dftran % r__heatflux (1:n) * Bhft2toWm2 * 3600.D+0
            case('axial node elevation, mm')
                var(:) = this % dftran % r__axnodelevat (1:n) * fttomm
            case('critical heat flux, w|m2')
                var(:) = this % dftran % r__crithtflux (1:n) * Bhft2toWm2 * 3600.D+0
            case('coolant pressure, mpa')
                var(:) = this % dftran % r__coolpress(1:n) * PSItoMPa
            case('surface heat transfer coefficient, w|m^2k')
                var(:) = this % dftran % r__filmcoeffav(1:n) * Bhft2FtoWm2K
            case('heat transfer coefficient, w|m^2k')
                var(:) = this % dftran % r__hgapav(1:n) * Bhft2FtoWm2K
            case('outer oxide thickness, mm')
                var(:) = this % dftran % r__eosoxidethick(1:n) * fttomm
            case('inner oxide thickness, mm')
                var(:) = this % dftran % r__oxithk2(1:n) * fttomm
            case('water metal reaction energy, kw|m')
                var(:) = this % dftran % r__watrmetlenrgy(1:n) / fttom
            case('axial node length, m')
                var(:) = this % dftran % r__axialnodlen(1:n) * fttom
            case('cladding permanent radial strain, %')
                var(:) = this % dftran % r__cldpermstrn(1:n)
            case('maximum energy half mesh can absorb in melting')
                var(:) = this % dftran % r__qmaxmelt(1:n)
            case('structural radial gap, mm')
                var(:) = this % dftran % r__rinterfacgap(1:n) * 1.2D+4 * miltomm
            case('interface pressure between fuel and cladding, mpa')
                var(:) = this % dftran % r__rinterfacprs(1:n) * PSItoMPa
            case('cladding effective stress, mpa')
                var(:) = this % dftran % r__cladeffstress(1:n) * PSItoMPa
            case('effective cladding strain, %')
                var(:) = this % dftran % r__effstrain(1:n)
            case('cladding instability strain, %')
                var(:) = this % dftran % r__einstabilstrain(1:n)
            case('stress at instability strain, mpa')
                var(:) = this % dftran % r__stressatinststrain(1:n)
            case('work-hardened yield stress, mpa')
                var(:) = this % dftran % r__cladyieldstress(1:n) * PSItoMPa
            case('flow area reduction')
                var(:) = this % dftran % r__farbal(1:n)
            case('standard deviation of flow area reduction')
                var(:) = this % dftran % r__sdfar(1:n)
            case('axial location flow area reduction subnodes, m')
                var(:) = this % dftran % r__zfarbl(1:n)
            case("sigmah")
                var(:) = this % dftran % r__CldStress(:,1)
            case("sigmaz")
                var(:) = this % dftran % r__CldStress(:,2)
            case('thermal radial gap, mm')
                var(:) = this % dftran % r__gapthick (1:n) * 1.2D+4 * miltomm
            case('cladding effective elastic-plastic strain, %')
                var(:) = this % dftran % r__EffStrainPNNL(1:n)
            case('coolant mass flux, kg|(s*m^2)')
                var(:) = this % dftran % r__rmassflux(1:n) * lbhrft2toksm2
            case('pellet surface displacement, mm')
                var(:) = this % dftran % r__PelSrfDispl(1:n) * fttomm
            case('structural gap interface pressure, mpa')
                var(:) = this % dftran % r__TerfacePres(1:n) * PSItoMPa
            case('coolant density, kg|m^3')
                var(:) = this % dftran % r__CoolDensity(1:n) * lbft3tokgm3
            case('pellet surface hoop strain, %')
                var(:) = this % dftran % r__PelSrfStrn(1:n,1)
            case('pellet surface axial strain, %')
                var(:) = this % dftran % r__PelSrfStrn(1:n,2)
            case('cladding hoop strain rate')
                var(:) = this % dftran % r__CldStrnRat(1:n,1)
            case('CladEnrgPerL')
                var(:) = this % dftran % r__CladEnrgPerL(1:n) / fttom
            case('EnergyPerL')
                var(:) = this % dftran % r__EnergyPerL(1:n) / fttom
            case('HFXSum')
                var(:) = this % dftran % r__HFXSum(1:n) / fttom
            case('k coefficient')
                var(:) = this % dftran % r__coefk(1:n)
            case('n coefficient')
                var(:) = this % dftran % r__coefn(1:n)
            case('m coefficient')
                var(:) = this % dftran % r__coefm(1:n)
            case('elastic modulus, mpa')
                var(:) = this % dftran % r__emodulus(1:n)
            case('strain rate coefficient')
                var(:) = this % dftran % r__strainrateterm(1:n)
            case('sed based on elastic-plastic effective strain')
                var(:) = this % dftran % r__sedpnnl(1:n)
            case("sed based on epri's formulation")
                var(:) = this % dftran % r__sedepri(1:n)
            case("coolant quality")
                var(:) = this % dftran % r__coolqual(1:n)
            case("c-p or b-j od oxygen uptake")
                var(:) = this % dftran % r__oxygenuptake(1:n)
            case("c-p or b-j id oxygen uptake")
                var(:) = this % dftran % r__oxuptakeid2(1:n)
            case("c-p or b-j cladding ecr")
                var(:) = this % dftran % r__ecr(1:n)
            case('centerline temperature, k')
                var(:) = (/( tfk(this % dftran % r__eostemp(1,i)), i = 1, n )/)
            case('pellet surface temperature, k')
                var(:) = (/( tfk(this % dftran % r__eostemp(this % dftran % r__igpnod,i)), i = 1, n )/)
            case('pellet centerline temperature, c')
                var(:) = (/( tfk(this % dftran % r__eostemp(1,i)), i = 1, n )/) - 273.15D0
            case('pellet surface temperature, c')
                var(:) = (/( tfk(this % dftran % r__eostemp(this % dftran % r__igpnod,i)), i = 1, n )/) - 273.15D0
            case('pellet doppler temperature, c')
                tmp1(:) = (/( tfk(this % dftran % r__eostemp(1,i)), i = 1, n )/) - 273.15D0
                tmp4(:) = (/( tkf(this % dftran % r__eostemp(this % dftran % r__igpnod,i)), i = 1, n )/) - 273.15D0
                var(:) = 0.93 * tmp1(:) + 0.07 * tmp4(:)
            case('cladding inner temperature, k')
                var(:) = (/( tfk(this % dftran % r__eostemp(this % dftran % r__ncladi,i)), i = 1, n )/)
            case("cladding outer temperature, k")
                var(:) = (/( tfk(this % dftran % r__eostemp(this % dftran % r__nmesh, i)), i = 1, n )/)
            case("bulk coolant temperature, k")
                var(:) = (/( tfk(this % dftran % r__BulkCoolTemp(i)), i = 1, n )/)
            case("bulk coolant temperature, c")
                var(:) = (/( tfk(this % dftran % r__BulkCoolTemp(i)), i = 1, n )/) - 273.15D0
            case default
                call error_message(key, 'real rank 1 in the fraptran get-list')
            end select
        end select

    end subroutine frod_get_r8_1


    subroutine frod_get_r8_2(this, key, var)

        class (t_fuelrod), intent(in) :: this

        character(*) :: key
        integer :: na, nr
        real(8)      :: var(:,:) ! array (n,)

        select case (this % frapmode)
        case ('frapcon')
            select case(lower(key))
            case('fuel temperature distribution, C') ! YU JIANKAI
                !tfc = (tf - 32.0_r8k) / 1.8_r8k
                do i = 1, n 
                    do j = 1, m + 1
                        var(j,i) = tfc(this % dfcon % r__tmpfuel(m + 2 - j, i))
                    enddo
                enddo 
            case default
                call error_message(key, 'real rank 2 in frapcon get-list')
            end select
        case ('fraptran')
            nr = this % dftran % r__nradialnodes
            na = this % dftran % r__naxn
            select case (lower(key))
            case('eos temperature, k')
                var(:,:) = (this % dftran % r__eostemp (1:nr, 1:na) + 4.5967D+2) / 1.8D+0
            case('eos radius, mm')
                var(:,:) = this % dftran % r__eosrad (1:nr, 1:na) * fttomm
            case('energy absorbed in melting')
                var(:,:) = this % dftran % r__enrgymeltz (1:nr,1:na)
            case('deformedradiusofmesh')
                var(:,:) = this % dftran % r__DeformedRadiusOfMesh (1:m,1:n) * fttomm
            case default
                call error_message(key, 'real rank 2 in fraptran get-list')
            end select
        end select

    end subroutine frod_get_r8_2

    subroutine frod_destroy(this)

        class (t_fuelrod), intent(inout) :: this

        select case (this % frapmode)
        case ('frapcon')
            call this % dfcon % destroy()
        case ('fraptran')
            call this % dftran % destroy()
        end select

    end subroutine frod_destroy

    subroutine error_message_0 (message)
        implicit none
        character(*) :: message
        write(*,*) message
        call backtrace
        stop
    end subroutine error_message_0

    subroutine error_message (vname, vtype)
        implicit none
        character(*) :: vname, vtype
        write(*,*) "ERROR: Could not find variable '", trim(vname), "' of the type ", vtype
        call backtrace
        stop
    end subroutine error_message

    subroutine stop_error (message, value)
        implicit none
        character(*) :: message
        integer :: value
        write(*,*) message, value
        call backtrace
        stop
    end subroutine stop_error

    subroutine assignvar (condition, a, b)
        logical, intent(in)  :: condition
        real(8), intent(in)  :: a
        real(8), intent(out) :: b(:)
        if (condition) then
            b(3) = a
        else
            b(1) = a
            b(2) = 0.d0
            b(3) = a
            b(4) = 1.d10
        endif
    end subroutine assignvar

end module frapi



